{{- if not .Values.secrets.existingSecret -}}
{{/*
  Use lookup function to preserve existing secrets on upgrade.
  This prevents regenerating tokens and API keys when the chart is upgraded.
*/}}
{{- $secretName := include "openclaw.secretName" . -}}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace $secretName -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "openclaw.labels" . | nindent 4 }}
  annotations:
    helm.sh/resource-policy: keep
    {{- with .Values.secrets.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
type: Opaque
data:
  {{- /* ANTHROPIC_API_KEY */}}
  {{- if .Values.secrets.anthropicApiKey }}
  ANTHROPIC_API_KEY: {{ .Values.secrets.anthropicApiKey | b64enc | quote }}
  {{- else if and $existingSecret $existingSecret.data }}
  ANTHROPIC_API_KEY: {{ index $existingSecret.data "ANTHROPIC_API_KEY" | default "" | quote }}
  {{- else }}
  ANTHROPIC_API_KEY: ""
  {{- end }}

  {{- /* OPENAI_API_KEY */}}
  {{- if .Values.secrets.openaiApiKey }}
  OPENAI_API_KEY: {{ .Values.secrets.openaiApiKey | b64enc | quote }}
  {{- else if and $existingSecret $existingSecret.data }}
  OPENAI_API_KEY: {{ index $existingSecret.data "OPENAI_API_KEY" | default "" | quote }}
  {{- else }}
  OPENAI_API_KEY: ""
  {{- end }}

  {{- /* DISCORD_BOT_TOKEN */}}
  {{- if .Values.secrets.discordBotToken }}
  DISCORD_BOT_TOKEN: {{ .Values.secrets.discordBotToken | b64enc | quote }}
  {{- else if and $existingSecret $existingSecret.data }}
  DISCORD_BOT_TOKEN: {{ index $existingSecret.data "DISCORD_BOT_TOKEN" | default "" | quote }}
  {{- else }}
  DISCORD_BOT_TOKEN: ""
  {{- end }}

  {{- /* TELEGRAM_BOT_TOKEN */}}
  {{- if .Values.secrets.telegramBotToken }}
  TELEGRAM_BOT_TOKEN: {{ .Values.secrets.telegramBotToken | b64enc | quote }}
  {{- else if and $existingSecret $existingSecret.data }}
  TELEGRAM_BOT_TOKEN: {{ index $existingSecret.data "TELEGRAM_BOT_TOKEN" | default "" | quote }}
  {{- else }}
  TELEGRAM_BOT_TOKEN: ""
  {{- end }}

  {{- /* SLACK_BOT_TOKEN */}}
  {{- if .Values.secrets.slackBotToken }}
  SLACK_BOT_TOKEN: {{ .Values.secrets.slackBotToken | b64enc | quote }}
  {{- else if and $existingSecret $existingSecret.data }}
  SLACK_BOT_TOKEN: {{ index $existingSecret.data "SLACK_BOT_TOKEN" | default "" | quote }}
  {{- else }}
  SLACK_BOT_TOKEN: ""
  {{- end }}

  {{- /* SLACK_APP_TOKEN */}}
  {{- if .Values.secrets.slackAppToken }}
  SLACK_APP_TOKEN: {{ .Values.secrets.slackAppToken | b64enc | quote }}
  {{- else if and $existingSecret $existingSecret.data }}
  SLACK_APP_TOKEN: {{ index $existingSecret.data "SLACK_APP_TOKEN" | default "" | quote }}
  {{- else }}
  SLACK_APP_TOKEN: ""
  {{- end }}

  {{- /* OPENCLAW_GATEWAY_TOKEN - Required */}}
  {{- if .Values.secrets.openclawGatewayToken }}
  OPENCLAW_GATEWAY_TOKEN: {{ .Values.secrets.openclawGatewayToken | b64enc | quote }}
  {{- else if and $existingSecret $existingSecret.data }}
  OPENCLAW_GATEWAY_TOKEN: {{ index $existingSecret.data "OPENCLAW_GATEWAY_TOKEN" | default "" | quote }}
  {{- else }}
  OPENCLAW_GATEWAY_TOKEN: {{ "change-me" | b64enc | quote }}
  {{- end }}

  {{- /* FEISHU_APP_ID */}}
  {{- if .Values.secrets.feishuAppId }}
  FEISHU_APP_ID: {{ .Values.secrets.feishuAppId | b64enc | quote }}
  {{- else if and $existingSecret $existingSecret.data }}
  FEISHU_APP_ID: {{ index $existingSecret.data "FEISHU_APP_ID" | default "" | quote }}
  {{- else }}
  FEISHU_APP_ID: ""
  {{- end }}

  {{- /* FEISHU_APP_SECRET */}}
  {{- if .Values.secrets.feishuAppSecret }}
  FEISHU_APP_SECRET: {{ .Values.secrets.feishuAppSecret | b64enc | quote }}
  {{- else if and $existingSecret $existingSecret.data }}
  FEISHU_APP_SECRET: {{ index $existingSecret.data "FEISHU_APP_SECRET" | default "" | quote }}
  {{- else }}
  FEISHU_APP_SECRET: ""
  {{- end }}

  {{- /* DINGTALK_CLIENT_ID */}}
  {{- if .Values.secrets.dingtalkClientId }}
  DINGTALK_CLIENT_ID: {{ .Values.secrets.dingtalkClientId | b64enc | quote }}
  {{- else if and $existingSecret $existingSecret.data }}
  DINGTALK_CLIENT_ID: {{ index $existingSecret.data "DINGTALK_CLIENT_ID" | default "" | quote }}
  {{- else }}
  DINGTALK_CLIENT_ID: ""
  {{- end }}

  {{- /* DINGTALK_CLIENT_SECRET */}}
  {{- if .Values.secrets.dingtalkClientSecret }}
  DINGTALK_CLIENT_SECRET: {{ .Values.secrets.dingtalkClientSecret | b64enc | quote }}
  {{- else if and $existingSecret $existingSecret.data }}
  DINGTALK_CLIENT_SECRET: {{ index $existingSecret.data "DINGTALK_CLIENT_SECRET" | default "" | quote }}
  {{- else }}
  DINGTALK_CLIENT_SECRET: ""
  {{- end }}

  {{- /* DINGTALK_ROBOT_CODE */}}
  {{- if .Values.secrets.dingtalkRobotCode }}
  DINGTALK_ROBOT_CODE: {{ .Values.secrets.dingtalkRobotCode | b64enc | quote }}
  {{- else if and $existingSecret $existingSecret.data }}
  DINGTALK_ROBOT_CODE: {{ index $existingSecret.data "DINGTALK_ROBOT_CODE" | default "" | quote }}
  {{- else }}
  DINGTALK_ROBOT_CODE: ""
  {{- end }}

  {{- /* DINGTALK_CORP_ID */}}
  {{- if .Values.secrets.dingtalkCorpId }}
  DINGTALK_CORP_ID: {{ .Values.secrets.dingtalkCorpId | b64enc | quote }}
  {{- else if and $existingSecret $existingSecret.data }}
  DINGTALK_CORP_ID: {{ index $existingSecret.data "DINGTALK_CORP_ID" | default "" | quote }}
  {{- else }}
  DINGTALK_CORP_ID: ""
  {{- end }}

  {{- /* DINGTALK_AGENT_ID */}}
  {{- if .Values.secrets.dingtalkAgentId }}
  DINGTALK_AGENT_ID: {{ .Values.secrets.dingtalkAgentId | b64enc | quote }}
  {{- else if and $existingSecret $existingSecret.data }}
  DINGTALK_AGENT_ID: {{ index $existingSecret.data "DINGTALK_AGENT_ID" | default "" | quote }}
  {{- else }}
  DINGTALK_AGENT_ID: ""
  {{- end }}

  {{- /* QQBOT_APP_ID */}}
  {{- if .Values.secrets.qqbotAppId }}
  QQBOT_APP_ID: {{ .Values.secrets.qqbotAppId | b64enc | quote }}
  {{- else if and $existingSecret $existingSecret.data }}
  QQBOT_APP_ID: {{ index $existingSecret.data "QQBOT_APP_ID" | default "" | quote }}
  {{- else }}
  QQBOT_APP_ID: ""
  {{- end }}

  {{- /* QQBOT_CLIENT_SECRET */}}
  {{- if .Values.secrets.qqbotClientSecret }}
  QQBOT_CLIENT_SECRET: {{ .Values.secrets.qqbotClientSecret | b64enc | quote }}
  {{- else if and $existingSecret $existingSecret.data }}
  QQBOT_CLIENT_SECRET: {{ index $existingSecret.data "QQBOT_CLIENT_SECRET" | default "" | quote }}
  {{- else }}
  QQBOT_CLIENT_SECRET: ""
  {{- end }}

  {{- /* WECOM_TOKEN */}}
  {{- if .Values.secrets.wecomToken }}
  WECOM_TOKEN: {{ .Values.secrets.wecomToken | b64enc | quote }}
  {{- else if and $existingSecret $existingSecret.data }}
  WECOM_TOKEN: {{ index $existingSecret.data "WECOM_TOKEN" | default "" | quote }}
  {{- else }}
  WECOM_TOKEN: ""
  {{- end }}

  {{- /* WECOM_ENCODING_AES_KEY */}}
  {{- if .Values.secrets.wecomEncodingAesKey }}
  WECOM_ENCODING_AES_KEY: {{ .Values.secrets.wecomEncodingAesKey | b64enc | quote }}
  {{- else if and $existingSecret $existingSecret.data }}
  WECOM_ENCODING_AES_KEY: {{ index $existingSecret.data "WECOM_ENCODING_AES_KEY" | default "" | quote }}
  {{- else }}
  WECOM_ENCODING_AES_KEY: ""
  {{- end }}
{{- end }}
